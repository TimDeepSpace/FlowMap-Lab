<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta http-equiv="Content-Style-Type" content="text/css">
  <title></title>
  <meta name="Generator" content="Cocoa HTML Writer">
  <meta name="CocoaVersion" content="2487.6">
  <style type="text/css">
    p.p1 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px Helvetica}
    p.p2 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px Helvetica; min-height: 14.0px}
  </style>
</head>
<body>
<p class="p1">&lt;!doctype html&gt;</p>
<p class="p1">&lt;html lang="en"&gt;</p>
<p class="p1">&lt;head&gt;</p>
<p class="p1">&lt;meta charset="utf-8" /&gt;</p>
<p class="p1">&lt;meta name="viewport" content="width=device-width,initial-scale=1" /&gt;</p>
<p class="p1">&lt;title&gt;Flowmap Lab — Standalone (Fix: no shorthand, robust export)&lt;/title&gt;</p>
<p class="p1">&lt;style&gt;</p>
<p class="p1"><span class="Apple-converted-space">  </span>:root{--bg:#0b0f14;--panel:#0f1621;--ink:#e6edf3;--muted:#94a3b8;--line:#203047}</p>
<p class="p1"><span class="Apple-converted-space">  </span>*{box-sizing:border-box} html,body{height:100%}</p>
<p class="p1"><span class="Apple-converted-space">  </span>body{margin:0;background:#0a0f16;color:#e6edf3;font:14px/1.4 system-ui,Segoe UI,Inter,Roboto,Arial,sans-serif;overflow:hidden;display:grid;grid-template-columns:auto 1fr}</p>
<p class="p1"><span class="Apple-converted-space">  </span>#dock{grid-column:1;margin:12px;display:flex;flex-direction:column;gap:10px;z-index:10;max-height:96vh;overflow:auto}</p>
<p class="p1"><span class="Apple-converted-space">  </span>.panel{background:#0f1621cc;border:1px solid #203047;backdrop-filter:blur(8px);border-radius:14px;padding:10px;min-width:300px;max-width:360px}</p>
<p class="p1"><span class="Apple-converted-space">  </span>.title{font-weight:700;margin-bottom:6px}</p>
<p class="p1"><span class="Apple-converted-space">  </span>.row{display:flex;align-items:center;gap:10px;margin:6px 0}</p>
<p class="p1"><span class="Apple-converted-space">  </span>.row&gt;label{flex:1;color:#94a3b8} .row&gt;input[type=range]{flex:2}</p>
<p class="p1"><span class="Apple-converted-space">  </span>.row&gt;select{flex:1;background:#0b1320;border:1px solid #2a3b54;border-radius:8px;color:#e6edf3;padding:6px 8px}</p>
<p class="p1"><span class="Apple-converted-space">  </span>.val{min-width:56px;text-align:right;color:#cbd5e1;font-variant-numeric:tabular-nums}</p>
<p class="p1"><span class="Apple-converted-space">  </span>.btn{appearance:none;border:1px solid #2a3b54;background:#0b1320;color:#e6edf3;border-radius:10px;padding:8px 12px;cursor:pointer}</p>
<p class="p1"><span class="Apple-converted-space">  </span>.btn:hover{border-color:#3d5a86}</p>
<p class="p1"><span class="Apple-converted-space">  </span>.grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}</p>
<p class="p1"><span class="Apple-converted-space">  </span>#stage{grid-column:2;display:flex;align-items:center;justify-content:center}</p>
<p class="p1"><span class="Apple-converted-space">  </span>#frame{position:relative;border:1px dashed #335;border-radius:10px;background:#0b0f14;padding:8px}</p>
<p class="p1"><span class="Apple-converted-space">  </span>#gl,#overlay{display:block} #overlay{position:absolute;left:8px;top:8px;pointer-events:none}</p>
<p class="p1"><span class="Apple-converted-space">  </span>#caption{position:absolute;left:50%;top:-12px;transform:translate(-50%,-100%);font-size:12px;color:#cbd5e1;background:#0f1621cc;border:1px solid #203047;border-radius:8px;padding:2px 8px}</p>
<p class="p1"><span class="Apple-converted-space">  </span>#toast{position:fixed;left:50%;transform:translateX(-50%);bottom:14px;background:#0f1621f2;border:1px solid #203047;border-radius:12px;padding:8px 12px;color:#cbd5e1;opacity:0;transition:opacity .2s;z-index:20}</p>
<p class="p1"><span class="Apple-converted-space">  </span>#toast.show{opacity:1}</p>
<p class="p1"><span class="Apple-converted-space">  </span>.diag-pass{color:#10b981}.diag-fail{color:#ef4444}</p>
<p class="p1">&lt;/style&gt;</p>
<p class="p1">&lt;/head&gt;</p>
<p class="p1">&lt;body&gt;</p>
<p class="p1"><span class="Apple-converted-space">  </span>&lt;div id="dock"&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;div class="panel"&gt;</p>
<p class="p1"><span class="Apple-converted-space">      </span>&lt;div class="title"&gt;Viewport&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">      </span>&lt;div class="row"&gt;&lt;label&gt;Resolution&lt;/label&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;select id="res"&gt;</p>
<p class="p1"><span class="Apple-converted-space">          </span>&lt;option value="512"&gt;512×512&lt;/option&gt;&lt;option value="768"&gt;768×768&lt;/option&gt;</p>
<p class="p1"><span class="Apple-converted-space">          </span>&lt;option value="1024" selected&gt;1024×1024&lt;/option&gt;&lt;option value="1536"&gt;1536×1536&lt;/option&gt;&lt;option value="2048"&gt;2048×2048&lt;/option&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;/select&gt;</p>
<p class="p1"><span class="Apple-converted-space">      </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">      </span>&lt;div class="row"&gt;&lt;label&gt;Seamless tiling&lt;/label&gt;&lt;input id="seamless" type="checkbox" checked&gt;&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">      </span>&lt;div class="grid"&gt;&lt;button id="btnPause" class="btn"&gt;Pause&lt;/button&gt;&lt;button id="btnReset" class="btn"&gt;Reset&lt;/button&gt;&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">      </span>&lt;div class="row" style="color:#94a3b8"&gt;Simulation and painting happen only inside the dashed box.&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;/div&gt;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;div class="panel"&gt;</p>
<p class="p1"><span class="Apple-converted-space">      </span>&lt;div class="title"&gt;Brushes&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">      </span>&lt;div class="row"&gt;&lt;label&gt;Tool&lt;/label&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;select id="tool"&gt;</p>
<p class="p1"><span class="Apple-converted-space">          </span>&lt;option value="force"&gt;Force (push)&lt;/option&gt;</p>
<p class="p1"><span class="Apple-converted-space">          </span>&lt;option value="swirl"&gt;Swirl (liquify)&lt;/option&gt;</p>
<p class="p1"><span class="Apple-converted-space">          </span>&lt;option value="paint"&gt;Paint Flow (RG)&lt;/option&gt;</p>
<p class="p1"><span class="Apple-converted-space">          </span>&lt;option value="erase"&gt;Erase (decay)&lt;/option&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;/select&gt;</p>
<p class="p1"><span class="Apple-converted-space">      </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">      </span>&lt;div class="row"&gt;&lt;label&gt;Brush size&lt;/label&gt;&lt;input id="brushSize" type="range" min="1" max="200" step="1" value="48"&gt;&lt;span id="brushSizeVal" class="val"&gt;48&lt;/span&gt;&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">      </span>&lt;div class="row"&gt;&lt;label&gt;Brush power&lt;/label&gt;&lt;input id="brushPower" type="range" min="0.01" max="6" step="0.01" value="1"&gt;&lt;span id="brushPowerVal" class="val"&gt;1.00&lt;/span&gt;&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">      </span>&lt;div class="row"&gt;&lt;label&gt;Swirl spiral (-in↔+out)&lt;/label&gt;&lt;input id="swirlSpiral" type="range" min="-1" max="1" step="0.01" value="0"&gt;&lt;span id="swirlSpiralVal" class="val"&gt;0.00&lt;/span&gt;&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">      </span>&lt;div class="row" style="color:#94a3b8"&gt;Hold LMB to accumulate swirl. Shift = straight • Ctrl/Cmd = invert.&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;/div&gt;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;div class="panel"&gt;</p>
<p class="p1"><span class="Apple-converted-space">      </span>&lt;div class="title"&gt;Noise / Turbulence&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">      </span>&lt;div class="row"&gt;&lt;label&gt;Strength&lt;/label&gt;&lt;input id="turbAmp" type="range" min="0" max="3" step="0.01" value="0"&gt;&lt;span id="turbAmpVal" class="val"&gt;0.00&lt;/span&gt;&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">      </span>&lt;div class="row"&gt;&lt;label&gt;Scale&lt;/label&gt;&lt;input id="turbScale" type="range" min="0.25" max="8" step="0.01" value="2"&gt;&lt;span id="turbScaleVal" class="val"&gt;2.00&lt;/span&gt;&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">      </span>&lt;div class="row"&gt;&lt;label&gt;Speed&lt;/label&gt;&lt;input id="turbSpeed" type="range" min="0" max="5" step="0.01" value="0"&gt;&lt;span id="turbSpeedVal" class="val"&gt;0.00&lt;/span&gt;&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;/div&gt;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;div class="panel"&gt;</p>
<p class="p1"><span class="Apple-converted-space">      </span>&lt;div class="title"&gt;Flow Smoothing&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">      </span>&lt;div class="row"&gt;&lt;label&gt;Smooth radius (px)&lt;/label&gt;&lt;input id="smoothRadius" type="range" min="0" max="12" step="1" value="0"&gt;&lt;span id="smoothRadiusVal" class="val"&gt;0&lt;/span&gt;&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">      </span>&lt;div class="row"&gt;&lt;label&gt;Smooth iters&lt;/label&gt;&lt;input id="smoothIters" type="range" min="0" max="8" step="1" value="1"&gt;&lt;span id="smoothItersVal" class="val"&gt;1&lt;/span&gt;&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">      </span>&lt;div class="row" style="color:#94a3b8"&gt;Vector-aware smoothing (affects preview &amp; export).&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;/div&gt;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;div class="panel"&gt;</p>
<p class="p1"><span class="Apple-converted-space">      </span>&lt;div class="title"&gt;Image Input&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">      </span>&lt;div class="row"&gt;&lt;input id="fileInput" type="file" accept="image/*" class="btn" /&gt;&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">      </span>&lt;div class="row"&gt;&lt;label&gt;Use RGB→Flow&lt;/label&gt;&lt;input id="useRGB" type="checkbox" checked&gt;&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">      </span>&lt;div class="row"&gt;&lt;label&gt;Use Luma as mask&lt;/label&gt;&lt;input id="useLuma" type="checkbox" checked&gt;&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">      </span>&lt;div class="row"&gt;&lt;label&gt;Image influence&lt;/label&gt;&lt;input id="imgInfluence" type="range" min="0" max="2" step="0.01" value="1"&gt;&lt;span id="imgInfluenceVal" class="val"&gt;1.00&lt;/span&gt;&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;/div&gt;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;div class="panel"&gt;</p>
<p class="p1"><span class="Apple-converted-space">      </span>&lt;div class="title"&gt;Export&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">      </span>&lt;div class="row"&gt;&lt;label&gt;Flow scale&lt;/label&gt;&lt;input id="flowScale" type="range" min="0.1" max="5" step="0.01" value="1"&gt;&lt;span id="flowScaleVal" class="val"&gt;1.00&lt;/span&gt;&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">      </span>&lt;div class="row"&gt;&lt;label&gt;Clamp flow&lt;/label&gt;&lt;input id="clampFlow" type="checkbox" checked&gt;&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">      </span>&lt;div class="row"&gt;&lt;label&gt;Blue channel (export)&lt;/label&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;select id="blueChan"&gt;</p>
<p class="p1"><span class="Apple-converted-space">          </span>&lt;option value="0" selected&gt;B = 0.0 (brown-like)&lt;/option&gt;</p>
<p class="p1"><span class="Apple-converted-space">          </span>&lt;option value="0.5"&gt;B = 0.5 (grey)&lt;/option&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;/select&gt;</p>
<p class="p1"><span class="Apple-converted-space">      </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">      </span>&lt;div class="grid"&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;button id="saveFlow" class="btn"&gt;Save PNG&lt;/button&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;button id="runDiag" class="btn"&gt;Self-check&lt;/button&gt;</p>
<p class="p1"><span class="Apple-converted-space">      </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">      </span>&lt;div id="diagOut" class="row" style="flex-direction:column;gap:4px;max-height:160px;overflow:auto"&gt;&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">      </span>&lt;div class="row" style="color:#94a3b8"&gt;Preview shows RG only (B=0). Export uses selected blue value.&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">  </span>&lt;/div&gt;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">  </span>&lt;div id="stage"&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;div id="frame"&gt;</p>
<p class="p1"><span class="Apple-converted-space">      </span>&lt;div id="caption"&gt;FLOWMAP VIEWPORT&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">      </span>&lt;canvas id="gl"&gt;&lt;/canvas&gt;</p>
<p class="p1"><span class="Apple-converted-space">      </span>&lt;canvas id="overlay"&gt;&lt;/canvas&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">  </span>&lt;/div&gt;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">  </span>&lt;div id="toast"&gt;&lt;/div&gt;</p>
<p class="p2"><br></p>
<p class="p1">&lt;script&gt;</p>
<p class="p1">(function() {</p>
<p class="p1"><span class="Apple-converted-space">  </span>var $ = function(s){ return document.querySelector(s); };</p>
<p class="p1"><span class="Apple-converted-space">  </span>var glCanvas = $('#gl'), overlay = $('#overlay'), frame = $('#frame');</p>
<p class="p1"><span class="Apple-converted-space">  </span>var gl = glCanvas.getContext('webgl2', {antialias:false, depth:false, stencil:false, premultipliedAlpha:false});</p>
<p class="p1"><span class="Apple-converted-space">  </span>if(!gl){ alert('WebGL2 is required.'); return; }</p>
<p class="p1"><span class="Apple-converted-space">  </span>var extCBF = gl.getExtension('EXT_color_buffer_float');</p>
<p class="p1"><span class="Apple-converted-space">  </span>var canFloatRT = !!extCBF;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">  </span>var W=1024,H=1024, paused=false, seamless=true, time=0;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">  </span>function setViewportSize(){</p>
<p class="p1"><span class="Apple-converted-space">    </span>glCanvas.width=W; glCanvas.height=H;</p>
<p class="p1"><span class="Apple-converted-space">    </span>glCanvas.style.width=W+'px'; glCanvas.style.height=H+'px';</p>
<p class="p1"><span class="Apple-converted-space">    </span>overlay.width=W; overlay.height=H; overlay.style.width=W+'px'; overlay.style.height=H+'px';</p>
<p class="p1"><span class="Apple-converted-space">    </span>frame.style.width=W+'px'; frame.style.height=H+'px';</p>
<p class="p1"><span class="Apple-converted-space">  </span>}</p>
<p class="p1"><span class="Apple-converted-space">  </span>function toast(msg){</p>
<p class="p1"><span class="Apple-converted-space">    </span>var t=$('#toast'); t.textContent=msg; t.classList.add('show'); setTimeout(function(){t.classList.remove('show');},1200);</p>
<p class="p1"><span class="Apple-converted-space">  </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">  </span>function valBind(id,fmt){</p>
<p class="p1"><span class="Apple-converted-space">    </span>if(!fmt) fmt=function(v){return v;};</p>
<p class="p1"><span class="Apple-converted-space">    </span>var el=$(id), sp=$(id+'Val');</p>
<p class="p1"><span class="Apple-converted-space">    </span>if(!el || !sp) return;</p>
<p class="p1"><span class="Apple-converted-space">    </span>var f=function(){ sp.textContent = fmt(el.value); };</p>
<p class="p1"><span class="Apple-converted-space">    </span>el.addEventListener('input', f); f();</p>
<p class="p1"><span class="Apple-converted-space">  </span>}</p>
<p class="p1"><span class="Apple-converted-space">  </span>['#brushSize','#smoothRadius','#smoothIters'].forEach(function(id){ valBind(id,function(v){return String(v);}); });</p>
<p class="p1"><span class="Apple-converted-space">  </span>['#brushPower','#swirlSpiral','#turbAmp','#turbScale','#turbSpeed','#imgInfluence','#flowScale'].forEach(function(id){ valBind(id,function(v){return Number(v).toFixed(2);}); });</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">  </span>function createTex(w,h, internal, format, type, filter){</p>
<p class="p1"><span class="Apple-converted-space">    </span>var tex=gl.createTexture(); gl.bindTexture(gl.TEXTURE_2D,tex);</p>
<p class="p1"><span class="Apple-converted-space">    </span>gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,filter); gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,filter);</p>
<p class="p1"><span class="Apple-converted-space">    </span>gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,seamless?gl.REPEAT:gl.CLAMP_TO_EDGE);</p>
<p class="p1"><span class="Apple-converted-space">    </span>gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,seamless?gl.REPEAT:gl.CLAMP_TO_EDGE);</p>
<p class="p1"><span class="Apple-converted-space">    </span>gl.texImage2D(gl.TEXTURE_2D,0,internal,w,h,0,format,type,null);</p>
<p class="p1"><span class="Apple-converted-space">    </span>return tex;</p>
<p class="p1"><span class="Apple-converted-space">  </span>}</p>
<p class="p1"><span class="Apple-converted-space">  </span>function createFBO(tex){</p>
<p class="p1"><span class="Apple-converted-space">    </span>var f=gl.createFramebuffer(); gl.bindFramebuffer(gl.FRAMEBUFFER,f);</p>
<p class="p1"><span class="Apple-converted-space">    </span>gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.TEXTURE_2D,tex,0); gl.bindFramebuffer(gl.FRAMEBUFFER,null); return f;</p>
<p class="p1"><span class="Apple-converted-space">  </span>}</p>
<p class="p1"><span class="Apple-converted-space">  </span>function pingpong(w,h, internal, format, type, filter){</p>
<p class="p1"><span class="Apple-converted-space">    </span>var a=createTex(w,h,internal,format,type,filter), b=createTex(w,h,internal,format,type,filter);</p>
<p class="p1"><span class="Apple-converted-space">    </span>return {</p>
<p class="p1"><span class="Apple-converted-space">      </span>w: w, h: h, read: a, write: b, fboR: createFBO(a), fboW: createFBO(b),</p>
<p class="p1"><span class="Apple-converted-space">      </span>swap: function(){ var t=this.read; this.read=this.write; this.write=t; t=this.fboR; this.fboR=this.fboW; this.fboW=t; }</p>
<p class="p1"><span class="Apple-converted-space">    </span>};</p>
<p class="p1"><span class="Apple-converted-space">  </span>}</p>
<p class="p1"><span class="Apple-converted-space">  </span>function bind(tex,unit){ gl.activeTexture(gl.TEXTURE0+unit); gl.bindTexture(gl.TEXTURE_2D, tex); }</p>
<p class="p1"><span class="Apple-converted-space">  </span>function program(vsSrc, fsSrc){</p>
<p class="p1"><span class="Apple-converted-space">    </span>var vs=gl.createShader(gl.VERTEX_SHADER); gl.shaderSource(vs,vsSrc); gl.compileShader(vs);</p>
<p class="p1"><span class="Apple-converted-space">    </span>if(!gl.getShaderParameter(vs,gl.COMPILE_STATUS)) throw gl.getShaderInfoLog(vs);</p>
<p class="p1"><span class="Apple-converted-space">    </span>var fs=gl.createShader(gl.FRAGMENT_SHADER); gl.shaderSource(fs,fsSrc); gl.compileShader(fs);</p>
<p class="p1"><span class="Apple-converted-space">    </span>if(!gl.getShaderParameter(fs,gl.COMPILE_STATUS)) throw gl.getShaderInfoLog(fs);</p>
<p class="p1"><span class="Apple-converted-space">    </span>var p=gl.createProgram(); gl.attachShader(p,vs); gl.attachShader(p,fs); gl.bindAttribLocation(p,0,'pos'); gl.linkProgram(p);</p>
<p class="p1"><span class="Apple-converted-space">    </span>if(!gl.getProgramParameter(p,gl.LINK_STATUS)) throw gl.getProgramInfoLog(p); return p;</p>
<p class="p1"><span class="Apple-converted-space">  </span>}</p>
<p class="p1"><span class="Apple-converted-space">  </span>function quad(){</p>
<p class="p1"><span class="Apple-converted-space">    </span>if(quad.vao) return;</p>
<p class="p1"><span class="Apple-converted-space">    </span>var v=gl.createBuffer(); gl.bindBuffer(gl.ARRAY_BUFFER,v);</p>
<p class="p1"><span class="Apple-converted-space">    </span>gl.bufferData(gl.ARRAY_BUFFER,new Float32Array([-1,-1,1,-1,-1,1,1,1]),gl.STATIC_DRAW);</p>
<p class="p1"><span class="Apple-converted-space">    </span>var vao=gl.createVertexArray(); gl.bindVertexArray(vao); gl.enableVertexAttribArray(0); gl.vertexAttribPointer(0,2,gl.FLOAT,false,0,0); quad.vao=vao;</p>
<p class="p1"><span class="Apple-converted-space">  </span>}</p>
<p class="p1"><span class="Apple-converted-space">  </span>function drawTo(fbo, prog, uniforms, viewportW, viewportH){</p>
<p class="p1"><span class="Apple-converted-space">    </span>if(viewportW==null) viewportW=W; if(viewportH==null) viewportH=H;</p>
<p class="p1"><span class="Apple-converted-space">    </span>gl.bindFramebuffer(gl.FRAMEBUFFER,fbo); gl.viewport(0,0,viewportW,viewportH);</p>
<p class="p1"><span class="Apple-converted-space">    </span>gl.useProgram(prog); var unit=0, i;</p>
<p class="p1"><span class="Apple-converted-space">    </span>if(uniforms){</p>
<p class="p1"><span class="Apple-converted-space">      </span>for(i=0;i&lt;uniforms.length;i++){</p>
<p class="p1"><span class="Apple-converted-space">        </span>var name=uniforms[i][0], val=uniforms[i][1];</p>
<p class="p1"><span class="Apple-converted-space">        </span>var loc=gl.getUniformLocation(prog,name); if(loc==null) continue;</p>
<p class="p1"><span class="Apple-converted-space">        </span>if(val &amp;&amp; val._isTex){ bind(val.tex,unit); gl.uniform1i(loc,unit); unit++; }</p>
<p class="p1"><span class="Apple-converted-space">        </span>else if(typeof val==='number'){ gl.uniform1f(loc,val); }</p>
<p class="p1"><span class="Apple-converted-space">        </span>else if(Object.prototype.toString.call(val)==='[object Array]'){</p>
<p class="p1"><span class="Apple-converted-space">          </span>if(val.length===2) gl.uniform2f(loc,val[0],val[1]); else if(val.length===3) gl.uniform3f(loc,val[0],val[1],val[2]); else if(val.length===4) gl.uniform4f(loc,val[0],val[1],val[2],val[3]);</p>
<p class="p1"><span class="Apple-converted-space">        </span>} else if(typeof val==='boolean'){ gl.uniform1i(loc, val?1:0); }</p>
<p class="p1"><span class="Apple-converted-space">      </span>}</p>
<p class="p1"><span class="Apple-converted-space">    </span>}</p>
<p class="p1"><span class="Apple-converted-space">    </span>gl.bindVertexArray(quad.vao); gl.drawArrays(gl.TRIANGLE_STRIP,0,4); gl.bindVertexArray(null);</p>
<p class="p1"><span class="Apple-converted-space">  </span>}</p>
<p class="p1"><span class="Apple-converted-space">  </span>function asTex(tex){ return { tex: tex, _isTex: true }; }</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">  </span>var VS = "#version 300 es\nlayout(location=0) in vec2 pos; out vec2 uv; void main(){ uv=pos*0.5+0.5; gl_Position=vec4(pos,0,1);} ";</p>
<p class="p1"><span class="Apple-converted-space">  </span>var FS_VIEW = "#version 300 es\nprecision highp float; in vec2 uv; out vec4 o; uniform sampler2D vel;\nvoid main(){ vec2 v=texture(vel,uv).xy*2.0-1.0; vec2 rg=v*0.5+0.5; o=vec4(rg,0.0,1.0);} ";</p>
<p class="p1"><span class="Apple-converted-space">  </span>var FS_EXPORT = "#version 300 es\nprecision highp float; in vec2 uv; out vec4 o; uniform sampler2D vel; uniform float scale; uniform bool clampF; uniform float blueVal;\nvoid main(){ vec2 v=texture(vel,uv).xy*2.0-1.0; v*=scale; if(clampF){ v=clamp(v,vec2(-1.),vec2(1.)); } o=vec4(v*0.5+0.5, blueVal, 1.0);} ";</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">  </span>var FS_FORCE = "#version 300 es\nprecision highp float; in vec2 uv; out vec4 o; uniform sampler2D vel; uniform vec2 center; uniform vec2 dir; uniform float radius; uniform float power;\nvoid main(){ vec2 v=texture(vel,uv).xy*2.0-1.0; float k=smoothstep(radius,0.0,distance(uv,center)); v+=dir*power*k; v=clamp(v,vec2(-2.),vec2(2.)); o=vec4(v*0.5+0.5,0.5,1.0);} ";</p>
<p class="p1"><span class="Apple-converted-space">  </span>var FS_SWIRL_WARP = "#version 300 es\nprecision highp float; in vec2 uv; out vec4 o; uniform sampler2D src; uniform vec2 center; uniform float radius; uniform float angle; uniform float spiral;\nvoid main(){ vec2 d=uv-center; float r=length(d); float k=smoothstep(radius,0.0,r); float th=angle*k; float c=cos(th), s=sin(th);\n vec2 dRot=mat2(c,-s,s,c)*d; vec2 radial=normalize(d+1e-5); vec2 dSpiral=radial*spiral*k*abs(angle)*0.5; vec2 uv2=center+dRot+dSpiral; o=texture(src,uv2);} ";</p>
<p class="p1"><span class="Apple-converted-space">  </span>var FS_ERASE = "#version 300 es\nprecision highp float; in vec2 uv; out vec4 o; uniform sampler2D vel; uniform vec2 center; uniform float radius; uniform float amount;\nvoid main(){ vec2 v=texture(vel,uv).xy*2.0-1.0; float k=smoothstep(radius,0.0,distance(uv,center)); v*=(1.0-k*amount); o=vec4(v*0.5+0.5,0.5,1.0);} ";</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">  </span>var FS_NOISE_DELTA = "#version 300 es\nprecision highp float; in vec2 uv; out vec4 o; uniform float t; uniform float amp; uniform float scale; uniform float speed;\nfloat h(vec2 p){ return fract(sin(dot(p,vec2(127.1,311.7)))*43758.5453);} float n(vec2 p){ vec2 i=floor(p),f=fract(p);\nfloat a=h(i),b=h(i+vec2(1,0)),c=h(i+vec2(0,1)),d=h(i+vec2(1,1)); vec2 u=f*f*(3.-2.*f); return mix(a,b,u.x)+(c-a)*u.y*(1.-u.x)+(d-b)*u.x*u.y;}\nvoid main(){ vec2 p=uv*scale+vec2(t*speed*0.07,-t*speed*0.05); float a=n(p), b=n(p+vec2(5.2,1.3));\n vec2 delta=normalize(vec2(a-0.5,b-0.5)+1e-5)*amp; o=vec4(delta*0.5+0.5,0.5,1.0);} ";</p>
<p class="p1"><span class="Apple-converted-space">  </span>var FS_ADD_FLOW = "#version 300 es\nprecision highp float; in vec2 uv; out vec4 o; uniform sampler2D flow; uniform sampler2D delta; uniform float dt;\nvoid main(){ vec2 v=texture(flow,uv).xy*2.0-1.0; vec2 d=(texture(delta,uv).xy*2.0-1.0)*dt; v=clamp(v+d,vec2(-2.),vec2(2.)); o=vec4(v*0.5+0.5,0.5,1.0);} ";</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">  </span>var FS_SMOOTH_H = "#version 300 es\nprecision highp float; in vec2 uv; out vec4 o; uniform sampler2D src; uniform vec2 texel; uniform float radius;\nfloat g(float x,float s){ return exp(-0.5*(x*x)/(s*s)); }\nvoid main(){ int rad=int(floor(radius+0.5)); if(rad&lt;=0){ o=texture(src,uv); return; } float sigma=max(0.6,float(rad)*0.5);\n vec2 acc=vec2(0.0); float wsum=0.0; for(int i=-12;i&lt;=12;i++){ if(abs(i)&gt;rad) continue; float fi=float(i); float w=g(fi,sigma);\n vec2 v=texture(src,uv+vec2(fi,0.0)*texel).xy*2.0-1.0; acc+=v*w; wsum+=w;} vec2 r=acc/max(wsum,1e-5); float L=clamp(length(r),0.0,2.0);\n vec2 outv=(L&gt;1e-5)? normalize(r)*L:vec2(0.0); o=vec4(outv*0.5+0.5,0.5,1.0);} ";</p>
<p class="p1"><span class="Apple-converted-space">  </span>var FS_SMOOTH_V = "#version 300 es\nprecision highp float; in vec2 uv; out vec4 o; uniform sampler2D src; uniform vec2 texel; uniform float radius;\nfloat g(float x,float s){ return exp(-0.5*(x*x)/(s*s)); }\nvoid main(){ int rad=int(floor(radius+0.5)); if(rad&lt;=0){ o=texture(src,uv); return; } float sigma=max(0.6,float(rad)*0.5);\n vec2 acc=vec2(0.0); float wsum=0.0; for(int i=-12;i&lt;=12;i++){ if(abs(i)&gt;rad) continue; float fi=float(i); float w=g(fi,sigma);\n vec2 v=texture(src,uv+vec2(0.0,fi)*texel).xy*2.0-1.0; acc+=v*w; wsum+=w;} vec2 r=acc/max(wsum,1e-5); float L=clamp(length(r),0.0,2.0);\n vec2 outv=(L&gt;1e-5)? normalize(r)*L:vec2(0.0); o=vec4(outv*0.5+0.5,0.5,1.0);} ";</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">  </span>var FS_COPY = "#version 300 es\nprecision highp float; in vec2 uv; out vec4 o; uniform sampler2D src; void main(){ o=texture(src,uv);} ";</p>
<p class="p1"><span class="Apple-converted-space">  </span>var FS_IMG2FLOW = "#version 300 es\nprecision highp float; in vec2 uv; out vec4 o; uniform sampler2D img; uniform float influence; uniform bool useRGB; uniform bool useLuma;\nvoid main(){ vec4 c=texture(img,uv); float l=dot(c.rgb,vec3(0.299,0.587,0.114)); vec2 base=useRGB?(c.rg*2.0-1.0):vec2(0.0);\n float m=useLuma?l:1.0; vec2 v=base*influence*m; o=vec4(v*0.5+0.5,0.5,1.0);} ";</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">  </span>var P_VIEW=program(VS,FS_VIEW), P_EXPORT=program(VS,FS_EXPORT),</p>
<p class="p1"><span class="Apple-converted-space">      </span>P_FORCE=program(VS,FS_FORCE), P_SWIRL=program(VS,FS_SWIRL_WARP), P_ERASE=program(VS,FS_ERASE),</p>
<p class="p1"><span class="Apple-converted-space">      </span>P_NOISE=program(VS,FS_NOISE_DELTA), P_ADD=program(VS,FS_ADD_FLOW),</p>
<p class="p1"><span class="Apple-converted-space">      </span>P_SMH=program(VS,FS_SMOOTH_H), P_SMV=program(VS,FS_SMOOTH_V),</p>
<p class="p1"><span class="Apple-converted-space">      </span>P_COPY=program(VS,FS_COPY), P_IMG=program(VS,FS_IMG2FLOW);</p>
<p class="p1"><span class="Apple-converted-space">  </span>quad();</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">  </span>var RGBAi=canFloatRT?gl.RGBA16F:gl.RGBA8, typ=canFloatRT?gl.HALF_FLOAT:gl.UNSIGNED_BYTE, filt=gl.LINEAR;</p>
<p class="p1"><span class="Apple-converted-space">  </span>var flow=pingpong(W,H,RGBAi,gl.RGBA,typ,filt);</p>
<p class="p1"><span class="Apple-converted-space">  </span>var tmpA={tex:createTex(W,H,RGBAi,gl.RGBA,typ,filt)}; tmpA.fbo=createFBO(tmpA.tex);</p>
<p class="p1"><span class="Apple-converted-space">  </span>var tmpB={tex:createTex(W,H,RGBAi,gl.RGBA,typ,filt)}; tmpB.fbo=createFBO(tmpB.tex);</p>
<p class="p1"><span class="Apple-converted-space">  </span>var delta={tex: createTex(W,H,RGBAi,gl.RGBA,typ,filt)}; delta.fbo=createFBO(delta.tex);<span class="Apple-converted-space">  </span>&lt;!-- FIXED: colon, not equals --&gt;</p>
<p class="p1"><span class="Apple-converted-space">  </span>var imgTex=null;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">  </span>function setWrapAll(){</p>
<p class="p1"><span class="Apple-converted-space">    </span>var list=[flow.read,flow.write,tmpA.tex,tmpB.tex,delta.tex,imgTex];</p>
<p class="p1"><span class="Apple-converted-space">    </span>for(var i=0;i&lt;list.length;i++){</p>
<p class="p1"><span class="Apple-converted-space">      </span>var t=list[i]; if(!t || !(t instanceof WebGLTexture) || !gl.isTexture(t)) continue;</p>
<p class="p1"><span class="Apple-converted-space">      </span>gl.bindTexture(gl.TEXTURE_2D,t);</p>
<p class="p1"><span class="Apple-converted-space">      </span>gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,seamless?gl.REPEAT:gl.CLAMP_TO_EDGE);</p>
<p class="p1"><span class="Apple-converted-space">      </span>gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,seamless?gl.REPEAT:gl.CLAMP_TO_EDGE);</p>
<p class="p1"><span class="Apple-converted-space">    </span>}</p>
<p class="p1"><span class="Apple-converted-space">    </span>gl.bindTexture(gl.TEXTURE_2D,null);</p>
<p class="p1"><span class="Apple-converted-space">  </span>}</p>
<p class="p1"><span class="Apple-converted-space">  </span>function clearAll(){</p>
<p class="p1"><span class="Apple-converted-space">    </span>gl.bindFramebuffer(gl.FRAMEBUFFER,flow.fboR); gl.viewport(0,0,W,H); gl.clearColor(0.5,0.5,0.5,1); gl.clear(gl.COLOR_BUFFER_BIT);</p>
<p class="p1"><span class="Apple-converted-space">    </span>gl.bindFramebuffer(gl.FRAMEBUFFER,flow.fboW); gl.clear(gl.COLOR_BUFFER_BIT); gl.bindFramebuffer(gl.FRAMEBUFFER,null);</p>
<p class="p1"><span class="Apple-converted-space">  </span>}</p>
<p class="p1"><span class="Apple-converted-space">  </span>function reset(res){</p>
<p class="p1"><span class="Apple-converted-space">    </span>W=res; H=res; setViewportSize();</p>
<p class="p1"><span class="Apple-converted-space">    </span>flow=pingpong(W,H,RGBAi,gl.RGBA,typ,filt);</p>
<p class="p1"><span class="Apple-converted-space">    </span>tmpA={tex:createTex(W,H,RGBAi,gl.RGBA,typ,filt)}; tmpA.fbo=createFBO(tmpA.tex);</p>
<p class="p1"><span class="Apple-converted-space">    </span>tmpB={tex:createTex(W,H,RGBAi,gl.RGBA,typ,filt)}; tmpB.fbo=createFBO(tmpB.tex);</p>
<p class="p1"><span class="Apple-converted-space">    </span>delta={tex: createTex(W,H,RGBAi,gl.RGBA,typ,filt)}; delta.fbo=createFBO(delta.tex);</p>
<p class="p1"><span class="Apple-converted-space">    </span>setWrapAll(); clearAll();</p>
<p class="p1"><span class="Apple-converted-space">  </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">  </span>var mouse={x:0,y:0,down:false,btn:0,dx:0,dy:0,ctrl:false,shift:false};</p>
<p class="p1"><span class="Apple-converted-space">  </span>function toUV(e){</p>
<p class="p1"><span class="Apple-converted-space">    </span>var r=glCanvas.getBoundingClientRect();</p>
<p class="p1"><span class="Apple-converted-space">    </span>var x=(e.clientX-r.left)/r.width, y=1-((e.clientY-r.top)/r.height);</p>
<p class="p1"><span class="Apple-converted-space">    </span>return {x:x, y:y, inside:(x&gt;=0&amp;&amp;x&lt;=1&amp;&amp;y&gt;=0&amp;&amp;y&lt;=1), r:r};</p>
<p class="p1"><span class="Apple-converted-space">  </span>}</p>
<p class="p1"><span class="Apple-converted-space">  </span>glCanvas.addEventListener('mousemove',function(e){</p>
<p class="p1"><span class="Apple-converted-space">    </span>var m=toUV(e); var r=m.r; mouse.dx=e.movementX/r.width; mouse.dy=e.movementY/r.height; mouse.x=m.x; mouse.y=m.y;</p>
<p class="p1"><span class="Apple-converted-space">  </span>});</p>
<p class="p1"><span class="Apple-converted-space">  </span>glCanvas.addEventListener('mousedown',function(e){ var m=toUV(e); if(!m.inside) return; mouse.down=true; mouse.btn=e.button; mouse.ctrl=e.ctrlKey||e.metaKey; mouse.shift=e.shiftKey; });</p>
<p class="p1"><span class="Apple-converted-space">  </span>addEventListener('mouseup',function(){ mouse.down=false; });</p>
<p class="p1"><span class="Apple-converted-space">  </span>glCanvas.oncontextmenu=function(e){ e.preventDefault(); };</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">  </span>function rRadius(){ return parseFloat($('#brushSize').value)/Math.max(W,H); }</p>
<p class="p1"><span class="Apple-converted-space">  </span>function rPower(){ return parseFloat($('#brushPower').value); }</p>
<p class="p1"><span class="Apple-converted-space">  </span>function swirlSpiral(){ return parseFloat($('#swirlSpiral').value); }</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">  </span>function applyForce(cx,cy,dx,dy,r,p){</p>
<p class="p1"><span class="Apple-converted-space">    </span>drawTo(flow.fboW,P_FORCE,[['vel',asTex(flow.read)],['center',[cx,cy]],['dir',[dx*(mouse.ctrl?-1:1), dy*(mouse.ctrl?-1:1)]],['radius',r],['power',p]]);</p>
<p class="p1"><span class="Apple-converted-space">    </span>flow.swap();</p>
<p class="p1"><span class="Apple-converted-space">  </span>}</p>
<p class="p1"><span class="Apple-converted-space">  </span>function applySwirlLiquify(cx,cy,r,p,dt){</p>
<p class="p1"><span class="Apple-converted-space">    </span>var ang=p*3.0*dt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>drawTo(flow.fboW,P_SWIRL,[['src',asTex(flow.read)],['center',[cx,cy]],['radius',r],['angle',ang*(mouse.ctrl?-1:1)],['spiral',swirlSpiral()]]);</p>
<p class="p1"><span class="Apple-converted-space">    </span>flow.swap();</p>
<p class="p1"><span class="Apple-converted-space">  </span>}</p>
<p class="p1"><span class="Apple-converted-space">  </span>function applyErase(cx,cy,r,amt){</p>
<p class="p1"><span class="Apple-converted-space">    </span>drawTo(flow.fboW,P_ERASE,[['vel',asTex(flow.read)],['center',[cx,cy]],['radius',r],['amount',amt]]);</p>
<p class="p1"><span class="Apple-converted-space">    </span>flow.swap();</p>
<p class="p1"><span class="Apple-converted-space">  </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">  </span>function handlePainting(dt){</p>
<p class="p1"><span class="Apple-converted-space">    </span>if(!mouse.down) return; var r=rRadius(), p=rPower(), tool=$('#tool').value;</p>
<p class="p1"><span class="Apple-converted-space">    </span>if(tool==='force'){</p>
<p class="p1"><span class="Apple-converted-space">      </span>var ddx=mouse.shift? (mouse.dx===0?0: (mouse.dx&gt;0?1:-1)*0.6) : mouse.dx;</p>
<p class="p1"><span class="Apple-converted-space">      </span>var ddy=mouse.shift? 0 : mouse.dy;</p>
<p class="p1"><span class="Apple-converted-space">      </span>applyForce(mouse.x,mouse.y, ddx*p, -ddy*p, r, 1.0);</p>
<p class="p1"><span class="Apple-converted-space">    </span>} else if(tool==='swirl'){</p>
<p class="p1"><span class="Apple-converted-space">      </span>applySwirlLiquify(mouse.x,mouse.y,r,p,dt);</p>
<p class="p1"><span class="Apple-converted-space">    </span>} else if(tool==='paint'){</p>
<p class="p1"><span class="Apple-converted-space">      </span>applyForce(mouse.x,mouse.y, mouse.dx*p, -mouse.dy*p, r, 1.0);</p>
<p class="p1"><span class="Apple-converted-space">    </span>} else if(tool==='erase'){</p>
<p class="p1"><span class="Apple-converted-space">      </span>applyErase(mouse.x,mouse.y,r, Math.min(1.0, 0.2*p));</p>
<p class="p1"><span class="Apple-converted-space">    </span>}</p>
<p class="p1"><span class="Apple-converted-space">  </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">  </span>$('#fileInput').addEventListener('change', function(e){</p>
<p class="p1"><span class="Apple-converted-space">    </span>var f=e.target.files[0]; if(!f) return;</p>
<p class="p1"><span class="Apple-converted-space">    </span>var img=new Image(); img.src=URL.createObjectURL(f);</p>
<p class="p1"><span class="Apple-converted-space">    </span>img.onload=function(){</p>
<p class="p1"><span class="Apple-converted-space">      </span>var c=document.createElement('canvas'); c.width=W; c.height=H; var ictx=c.getContext('2d'); ictx.drawImage(img,0,0,W,H);</p>
<p class="p1"><span class="Apple-converted-space">      </span>if(!imgTex) imgTex=gl.createTexture(); gl.bindTexture(gl.TEXTURE_2D,imgTex);</p>
<p class="p1"><span class="Apple-converted-space">      </span>gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR); gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.LINEAR);</p>
<p class="p1"><span class="Apple-converted-space">      </span>gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,seamless?gl.REPEAT:gl.CLAMP_TO_EDGE); gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,seamless?gl.REPEAT:gl.CLAMP_TO_EDGE);</p>
<p class="p1"><span class="Apple-converted-space">      </span>gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,c);</p>
<p class="p1"><span class="Apple-converted-space">      </span>var useRGB=$('#useRGB').checked, useLuma=$('#useLuma').checked, infl=parseFloat($('#imgInfluence').value);</p>
<p class="p1"><span class="Apple-converted-space">      </span>drawTo(flow.fboW, P_IMG, [['img',asTex(imgTex)], ['influence', infl], ['useRGB', useRGB], ['useLuma', useLuma]]);</p>
<p class="p1"><span class="Apple-converted-space">      </span>flow.swap(); toast('Image applied to flow');</p>
<p class="p1"><span class="Apple-converted-space">    </span>};</p>
<p class="p1"><span class="Apple-converted-space">  </span>});</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">  </span>function smoothTex(src){</p>
<p class="p1"><span class="Apple-converted-space">    </span>var rad=parseFloat($('#smoothRadius').value);</p>
<p class="p1"><span class="Apple-converted-space">    </span>var iters=parseInt($('#smoothIters').value,10);</p>
<p class="p1"><span class="Apple-converted-space">    </span>if(rad&lt;=0 || iters&lt;=0) return src;</p>
<p class="p1"><span class="Apple-converted-space">    </span>var texel=[1/W,1/H]; var cur=src, i;</p>
<p class="p1"><span class="Apple-converted-space">    </span>for(i=0;i&lt;iters;i++){</p>
<p class="p1"><span class="Apple-converted-space">      </span>drawTo(tmpA.fbo, P_SMH, [['src',asTex(cur)], ['texel',texel], ['radius',rad]]);</p>
<p class="p1"><span class="Apple-converted-space">      </span>drawTo(tmpB.fbo, P_SMV, [['src',asTex(tmpA.tex)], ['texel',texel], ['radius',rad]]);</p>
<p class="p1"><span class="Apple-converted-space">      </span>cur = tmpB.tex;</p>
<p class="p1"><span class="Apple-converted-space">    </span>}</p>
<p class="p1"><span class="Apple-converted-space">    </span>return cur;</p>
<p class="p1"><span class="Apple-converted-space">  </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">  </span>// ——— Export: open image in same tab (works in strict environments) ———</p>
<p class="p1"><span class="Apple-converted-space">  </span>function savePNG(){</p>
<p class="p1"><span class="Apple-converted-space">    </span>try{</p>
<p class="p1"><span class="Apple-converted-space">      </span>var src=smoothTex(flow.read);</p>
<p class="p1"><span class="Apple-converted-space">      </span>var scale=parseFloat($('#flowScale').value), clampF=$('#clampFlow').checked, blueVal=parseFloat($('#blueChan').value);</p>
<p class="p1"><span class="Apple-converted-space">      </span>var outTex=createTex(W,H,gl.RGBA8,gl.RGBA,gl.UNSIGNED_BYTE,gl.NEAREST), outFbo=createFBO(outTex);</p>
<p class="p1"><span class="Apple-converted-space">      </span>drawTo(outFbo, P_EXPORT, [['vel',asTex(src)], ['scale', scale], ['clampF', clampF], ['blueVal', blueVal]]);</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">      </span>var pixels=new Uint8Array(W*H*4); gl.bindFramebuffer(gl.FRAMEBUFFER,outFbo); gl.readPixels(0,0,W,H,gl.RGBA,gl.UNSIGNED_BYTE,pixels);</p>
<p class="p1"><span class="Apple-converted-space">      </span>var out=document.createElement('canvas'); out.width=W; out.height=H;</p>
<p class="p1"><span class="Apple-converted-space">      </span>var ctx=out.getContext('2d'); var imgData=ctx.createImageData(W,H); var row=W*4, y;</p>
<p class="p1"><span class="Apple-converted-space">      </span>for(y=0;y&lt;H;y++){ imgData.data.set(pixels.subarray((H-1-y)*row,(H-y)*row), y*row); }</p>
<p class="p1"><span class="Apple-converted-space">      </span>ctx.putImageData(imgData,0,0);</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">      </span>var dataURL = out.toDataURL('image/png');<span class="Apple-converted-space">  </span>// синхронно, в контексте клика</p>
<p class="p1"><span class="Apple-converted-space">      </span>window.location.href = dataURL;<span class="Apple-converted-space">            </span>// гарантированно «открывает картинку»</p>
<p class="p1"><span class="Apple-converted-space">    </span>}catch(err){ console.error(err); alert('Save error: '+err); }</p>
<p class="p1"><span class="Apple-converted-space">  </span>}</p>
<p class="p1"><span class="Apple-converted-space">  </span>$('#saveFlow').addEventListener('click', savePNG);</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">  </span>// ——— Diagnostics / tests ———</p>
<p class="p1"><span class="Apple-converted-space">  </span>function addDiag(msg, ok){</p>
<p class="p1"><span class="Apple-converted-space">    </span>var p=document.createElement('div'); p.innerHTML=(ok?'&lt;span class="diag-pass"&gt;✔&lt;/span&gt; ':'&lt;span class="diag-fail"&gt;✖&lt;/span&gt; ')+msg; $('#diagOut').appendChild(p);</p>
<p class="p1"><span class="Apple-converted-space">  </span>}</p>
<p class="p1"><span class="Apple-converted-space">  </span>$('#runDiag').onclick=function(){</p>
<p class="p1"><span class="Apple-converted-space">    </span>$('#diagOut').innerHTML='';</p>
<p class="p1"><span class="Apple-converted-space">    </span>try{</p>
<p class="p1"><span class="Apple-converted-space">      </span>addDiag('GL2 context', !!gl);</p>
<p class="p1"><span class="Apple-converted-space">      </span>var fb=createFBO(createTex(32,32,gl.RGBA8,gl.RGBA,gl.UNSIGNED_BYTE,gl.NEAREST)); gl.bindFramebuffer(gl.FRAMEBUFFER,fb);</p>
<p class="p1"><span class="Apple-converted-space">      </span>addDiag('FBO complete', gl.checkFramebufferStatus(gl.FRAMEBUFFER)===gl.FRAMEBUFFER_COMPLETE);</p>
<p class="p1"><span class="Apple-converted-space">      </span>addDiag('Ping-pong swap works', (function(){ var pp=pingpong(8,8,gl.RGBA8,gl.RGBA,gl.UNSIGNED_BYTE,gl.NEAREST); var before=pp.read; pp.swap(); return pp.read!==before; })());</p>
<p class="p1"><span class="Apple-converted-space">      </span>addDiag('Delta texture created', (function(){ return gl.isTexture(delta.tex); })());</p>
<p class="p1"><span class="Apple-converted-space">      </span>addDiag('Export path: Same tab via data:URL', true);</p>
<p class="p1"><span class="Apple-converted-space">    </span>}catch(e){ addDiag('Exception: '+e, false); }</p>
<p class="p1"><span class="Apple-converted-space">  </span>};</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">  </span>function drawOverlay(){</p>
<p class="p1"><span class="Apple-converted-space">    </span>var ctx=overlay.getContext('2d'); ctx.clearRect(0,0,overlay.width,overlay.height);</p>
<p class="p1"><span class="Apple-converted-space">    </span>ctx.strokeStyle='rgba(96,165,250,0.9)'; ctx.setLineDash([8,6]); ctx.strokeRect(0.5,0.5,W-1,H-1); ctx.setLineDash([]);</p>
<p class="p1"><span class="Apple-converted-space">  </span>}</p>
<p class="p1"><span class="Apple-converted-space">  </span>function tick(dt){</p>
<p class="p1"><span class="Apple-converted-space">    </span>var amp=parseFloat($('#turbAmp').value), scl=parseFloat($('#turbScale').value), spd=parseFloat($('#turbSpeed').value);</p>
<p class="p1"><span class="Apple-converted-space">    </span>if(amp&gt;0){</p>
<p class="p1"><span class="Apple-converted-space">      </span>drawTo(delta.fbo, P_NOISE, [['t', time], ['amp', amp], ['scale', scl], ['speed', spd]]);</p>
<p class="p1"><span class="Apple-converted-space">      </span>drawTo(flow.fboW, P_ADD, [['flow',asTex(flow.read)], ['delta',asTex(delta.tex)], ['dt', dt]]);</p>
<p class="p1"><span class="Apple-converted-space">      </span>flow.swap();</p>
<p class="p1"><span class="Apple-converted-space">    </span>}</p>
<p class="p1"><span class="Apple-converted-space">    </span>handlePainting(dt);</p>
<p class="p1"><span class="Apple-converted-space">  </span>}</p>
<p class="p1"><span class="Apple-converted-space">  </span>function boot(){ setViewportSize(); setWrapAll(); clearAll(); drawOverlay(); requestAnimationFrame(loop); }</p>
<p class="p1"><span class="Apple-converted-space">  </span>var last=performance.now();</p>
<p class="p1"><span class="Apple-converted-space">  </span>function loop(now){</p>
<p class="p1"><span class="Apple-converted-space">    </span>var dt=Math.min(0.033,(now-last)/1000); last=now; if(!paused){ time+=dt; tick(dt); }</p>
<p class="p1"><span class="Apple-converted-space">    </span>var src=smoothTex(flow.read);</p>
<p class="p1"><span class="Apple-converted-space">    </span>gl.bindFramebuffer(gl.FRAMEBUFFER,null); gl.viewport(0,0,W,H);</p>
<p class="p1"><span class="Apple-converted-space">    </span>gl.useProgram(P_VIEW); gl.bindVertexArray(quad.vao); bind(src,0); gl.uniform1i(gl.getUniformLocation(P_VIEW,'vel'),0); gl.drawArrays(gl.TRIANGLE_STRIP,0,4);</p>
<p class="p1"><span class="Apple-converted-space">    </span>requestAnimationFrame(loop);</p>
<p class="p1"><span class="Apple-converted-space">  </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">  </span>$('#res').onchange=function(e){ var r=parseInt(e.target.value,10); reset(r); toast('Resolution '+r); };</p>
<p class="p1"><span class="Apple-converted-space">  </span>$('#seamless').onchange=function(e){ seamless=e.target.checked; setWrapAll(); toast('Seamless '+(seamless?'ON':'OFF')); };</p>
<p class="p1"><span class="Apple-converted-space">  </span>$('#btnPause').onclick=function(){ paused=!paused; $('#btnPause').textContent=paused?'Resume':'Pause'; };</p>
<p class="p1"><span class="Apple-converted-space">  </span>$('#btnReset').onclick=function(){ clearAll(); toast('Reset'); };</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">  </span>boot();</p>
<p class="p1">})();</p>
<p class="p1">&lt;/script&gt;</p>
<p class="p1">&lt;/body&gt;</p>
<p class="p1">&lt;/html&gt;</p>
</body>
</html>
